{% extends "base.html" %}
{% block title %}Buyer Dashboard{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- HEADER -->
  <h2 class="fw-bold mb-1">üõí Buyer Dashboard</h2>

  <p class="text-muted mb-4">
    Maligayang pagbabalik,
    {{ current_user.full_name or current_user.username }}!
  </p>

  <!-- AI SEARCH -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">

      <h5 class="fw-bold mb-3">
        ü§ñ AI Paghahanap ng Produkto
      </h5>

      <!-- ‚úÖ Added id -->
      <form id="searchForm">
        <div class="input-group">

          <input type="text"
                 name="q"
                 id="searchInput"
                 class="form-control"
                 placeholder="Maghanap hal. kamatis..."
                 required>

          <button class="btn btn-success">
            üîç Maghanap
          </button>

        </div>
      </form>

    </div>
  </div>

  <!-- ‚úÖ SEARCH RESULTS (ADDED, hidden by default) -->
  <div id="searchResults" class="row g-3 mb-4" style="display:none;"></div>

  <!-- PRODUCTS -->
  <h4 class="fw-bold mb-3">üåæ Available Products</h4>

  <!-- ‚úÖ Wrapped default products -->
  <div id="defaultProducts" class="row g-3">

    {% for product in products %}

    <div class="col-md-4">
      <div class="card shadow-sm h-100">

        <img src="{{ url_for('static',
              filename='uploads/' + (product.image or 'default_product.jpg')) }}"
             class="card-img-top"
             style="height:200px; object-fit:cover;">

        <div class="card-body">

          <h5 class="card-title">
            {{ product.name }}
          </h5>

          <p class="mb-1">
            <strong>Magsasaka:</strong>
            {{ product.farmer.full_name or product.farmer.username }}
          </p>

          <p class="mb-1">
            <strong>Lugar:</strong>
            {{ product.location }}
          </p>

          <p class="mb-1">
            <strong>Stock:</strong>
            {{ product.stock_quantity }} kg
          </p>

          <h6 class="text-success fw-bold">
            ‚Ç±{{ product.price }}/kg
          </h6>

          <a href="{{ url_for('products.product_detail',
                               product_id=product.id) }}"
             class="btn btn-success btn-sm mt-2 w-100">
             Tingnan ang Produkto
          </a>

        </div>
      </div>
    </div>

    {% else %}

    <div class="col-12 text-center text-muted py-4">
      Wala pang available na produkto.
    </div>

    {% endfor %}

  </div>

</div>


<!-- ‚úÖ AJAX SEARCH SCRIPT (ADDED) -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const form = document.getElementById("searchForm");
  const input = document.getElementById("searchInput");
  const resultsDiv = document.getElementById("searchResults");
  const defaultDiv = document.getElementById("defaultProducts");

  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    const query = input.value.trim();
    if (!query) return;

    resultsDiv.style.display = "flex";
    defaultDiv.style.display = "none";

    resultsDiv.innerHTML = "<p>Searching...</p>";

    try {

      // ‚úÖ FIXED BACKTICKS
      const res = await fetch(`/api/search-products?q=${encodeURIComponent(query)}`);
      const data = await res.json();

      resultsDiv.innerHTML = "";

      if (data.length === 0) {
        resultsDiv.innerHTML =
          "<div class='col-12 text-muted'>Walang nahanap.</div>";
        return;
      }

      data.forEach(product => {
        resultsDiv.innerHTML += `
          <div class="col-md-4">
            <div class="card shadow-sm h-100">
              <div class="card-body">

                <h5>${product.name}</h5>

                <p><strong>Magsasaka:</strong> ${product.farmer}</p>
                <p><strong>Lugar:</strong> ${product.location}</p>
                <p><strong>Stock:</strong> ${product.stock} kg</p>

                <h6 class="text-success fw-bold">
                  ‚Ç±${product.price}/kg
                </h6>

              </div>
            </div>
          </div>
        `;
      });

    } catch (err) {
      resultsDiv.innerHTML =
        "<div class='col-12 text-danger'>Search failed.</div>";
    }

  });

});
</script>
{% endblock %}