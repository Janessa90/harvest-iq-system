{% extends "base.html" %}

{% block title %}
Ebili
{% endblock %}

{% block content %}
<div class="container py-4">

<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between align-items-center flex-wrap mb-4">

  <div>
    <h2 class="fw-bold mb-1">ğŸ›’ Ebili</h2>
    <p class="text-muted mb-0">
      Maligayang pagbabalik,
      {{ current_user.full_name or current_user.username }}!
    </p>
  </div>

  <div class="d-flex gap-2">
    <a href="{{ url_for('orders.my_orders') }}"
       class="btn btn-outline-dark">
       ğŸ“¦ My Orders
    </a>

    <a href="{{ url_for('cart.view_cart') }}"
       class="btn btn-outline-success">
       ğŸ›’ Cart
    </a>
  </div>

</div>


<!-- ================= SEARCH ================= -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">

    <div class="input-group">
      <input type="text"
             id="searchInput"
             class="form-control"
             placeholder="Maghanap hal. kamatis...">

      <button class="btn btn-success">
        ğŸ” Maghanap
      </button>
    </div>

  </div>
</div>


<!-- ================= SEARCH RESULTS ================= -->
<div id="searchResults"
     class="row g-3 mb-4"
     style="display:none;">
</div>


<!-- ================= DEFAULT PRODUCTS ================= -->
<h4 class="fw-bold mb-3">ğŸŒ¾ Available Products</h4>

<div id="defaultProducts" class="row g-3">

{% for product in products %}
<div class="col-md-4 col-lg-3">

<div class="card shadow-sm h-100">

<img src="{{ url_for('static',
filename='uploads/' + (product.image or 'default_product.jpg')) }}"
class="card-img-top"
style="height:200px;object-fit:cover;">

<div class="card-body d-flex flex-column">

<h5>{{ product.name }}</h5>

<p class="mb-1">
<strong>Seller:</strong>
{{ product.farmer.full_name or product.farmer.username }}
</p>

<p class="mb-1">
<strong>Lugar:</strong>
{{ product.location }}
</p>

<p class="mb-2">
<strong>Stock:</strong>
{{ product.stock_quantity }} kg
</p>

<h6 class="text-success fw-bold">
â‚±{{ product.price }}/kg
</h6>

<form method="POST"
action="{{ url_for('cart.add_to_cart',
product_id=product.id) }}"
class="mt-auto">

<input type="hidden" name="quantity" value="1">

<button class="btn btn-success w-100">
Add to Cart
</button>

</form>

</div>
</div>
</div>
{% endfor %}

</div>
</div>


<!-- ================= LIVE SEARCH ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

const input = document.getElementById("searchInput");
const resultsDiv = document.getElementById("searchResults");
const defaultDiv = document.getElementById("defaultProducts");

let timeout = null;

input.addEventListener("keyup", () => {

clearTimeout(timeout);

const query = input.value.trim();

if(query.length === 0){
    resultsDiv.style.display="none";
    defaultDiv.style.display="flex";
    return;
}

timeout = setTimeout(async () => {

resultsDiv.style.display="flex";
defaultDiv.style.display="none";

resultsDiv.innerHTML =
"<div class='col-12'>Searching...</div>";

try{

const res = await fetch(
                `/search/api/search-products?q=${encodeURIComponent(query)}`
            );

const data = await res.json();

resultsDiv.innerHTML="";

if(data.length === 0){
resultsDiv.innerHTML =
"<div class='col-12 text-muted'>Walang nahanap.</div>";
return;
}

data.forEach(product => {

resultsDiv.innerHTML += `
<div class="col-md-4 col-lg-3">

<div class="card shadow-sm h-100">

<img src="/static/uploads/${product.image || 'default_product.jpg'}"
class="card-img-top"
style="height:200px;object-fit:cover;">

<div class="card-body d-flex flex-column">

<h5>${product.name}</h5>

<p class="mb-1">
<strong>Seller:</strong>
${product.farmer}
</p>

<p class="mb-1">
<strong>Lugar:</strong>
${product.location}
</p>

<p class="mb-2">
<strong>Stock:</strong>
${product.stock} kg
</p>

<h6 class="text-success fw-bold">
â‚±${product.price}/kg
</h6>

<form method="POST"
action="/cart/add/${product.id}"
class="mt-auto">

<input type="hidden" name="quantity" value="1">

<button class="btn btn-success w-100">
Add to Cart
</button>

</form>

</div>
</div>
</div>
`;
});

}catch(e){
resultsDiv.innerHTML =
"<div class='text-danger'>Search failed</div>";
}

},300);

});
});
</script>

{% endblock %}