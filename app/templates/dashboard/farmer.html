{% extends 'base.html' %}
{% block title %}Ebenta{% endblock %}

{% block content %}
<div class="container py-4">

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4">

<div>
<h2 class="fw-bold mb-1">ğŸ‘¨â€ğŸŒ¾ Ebenta</h2>
<p class="text-muted mb-0">
{{ current_user.full_name or current_user.username }}
</p>
<small class="text-muted">
{{ current_user.city }}, {{ current_user.province }}
</small>
</div>

<a href="{{ url_for('products.add_product') }}"
class="btn btn-outline-success">
Magdagdag ng Produkto
</a>

</div>


{% if current_user.status == "approved" %}

<div class="card shadow-sm border-0 mb-4">
<div class="card-body">

<h5 class="fw-bold mb-3">
ğŸ“¦ Detalye ng Ititimbang na Produkto
</h5>

<form id="weighForm">

<div class="row g-3">

<div class="col-md-6">
<label>Pangalan ng Produkto</label>
<input type="text"
id="product_name"
class="form-control"
required>
</div>

<div class="col-md-6">
<label>Presyo / Kilo</label>
<input type="number"
id="price"
class="form-control"
step="0.01"
required>
</div>

</div>

<div class="mt-3 d-flex gap-2">

<button type="button"
id="startWeighBtn"
class="btn btn-success"
data-farmer-id="{{ current_user.id }}">
âš– Simulan ang Pagtitimbang
</button>

<button type="button"
id="stopWeighBtn"
class="btn btn-danger"
disabled>
ğŸ›‘ Itigil
</button>

</div>

</form>

</div>
</div>

{% endif %}

<div id="weighStatus"></div>


<!-- PRODUCTS -->
<div class="card border-0 shadow-sm">

<div class="card-header fw-bold">
Aking Mga Produkto
</div>

<div class="card-body">

{% if farmer_products %}
{% for product in farmer_products %}
<p>
{{ product.name }}
â€” â‚±{{ product.price }}/kg
</p>
{% endfor %}
{% else %}
<div class="text-muted text-center">
Wala pang approved na produkto.
</div>
{% endif %}

</div>
</div>

</div>



<!-- âœ…âœ…âœ… FIXED SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", () => {

const startBtn = document.getElementById("startWeighBtn");
const stopBtn = document.getElementById("stopWeighBtn");
const statusDiv = document.getElementById("weighStatus");

if(!startBtn){
console.log("âŒ start button missing");
return;
}

const farmerId = startBtn.dataset.farmerId;
console.log("âœ… Farmer:", farmerId);


// ================= START =================
startBtn.onclick = async () => {

console.log("ğŸ”¥ START CLICKED");

const product =
document.getElementById("product_name").value;

const price =
document.getElementById("price").value;

if(!product || !price){
alert("Fill product & price");
return;
}

try{

const res = await fetch("/api/start-weighing",{
method:"POST",
headers:{
"Content-Type":"application/json"
},
body:JSON.stringify({
farmer_id:Number(farmerId),
device_id:1,
product_name:product,
price:price
})
});

console.log("STATUS:",res.status);

const data = await res.json();
console.log("RESPONSE:",data);

if(data.status==="started"){

statusDiv.innerHTML=
`<div class="alert alert-success">
âœ… Weighing Started
</div>`;

startBtn.disabled=true;
stopBtn.disabled=false;

}

}catch(err){
console.error("FETCH ERROR:",err);
}

};


// ================= STOP =================
stopBtn.onclick = async ()=>{

await fetch("/api/stop-weighing",{method:"POST"});

statusDiv.innerHTML=
`<div class="alert alert-warning">
Stopped
</div>`;

startBtn.disabled=false;
stopBtn.disabled=true;

};

});
</script>


{% endblock %}