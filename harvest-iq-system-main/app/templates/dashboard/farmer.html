{% extends 'base.html' %}
{% block title %}Dashboard ng Magsasaka{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">

    <div>
      <h2 class="fw-bold mb-1">üë®‚Äçüåæ Dashboard ng Magsasaka</h2>
      <p class="text-muted mb-0">
        Maligayang pagbabalik,
        {{ current_user.full_name or current_user.username }}
      </p>
    </div>

    <div class="d-flex gap-2">

      <!-- ADD PRODUCT -->
      <a href="{{ url_for('products.add_product') }}"
         class="btn btn-outline-success">
         <i class="fas fa-plus me-2"></i>
         Magdagdag ng Produkto
      </a>

      <!-- START WEIGHING -->
      {% if current_user.status == "approved" %}
      <button id="startWeighBtn"
              class="btn btn-success">
              ‚öñ Simulan ang Pagtitimbang
      </button>
      {% else %}
      <button class="btn btn-secondary" disabled>
        Naghihintay ng Approval ng Admin
      </button>
      {% endif %}

    </div>
  </div>

  <!-- STATUS MESSAGE -->
  <div id="weighStatus"></div>

  <!-- STATS -->
  <div class="row g-3 mb-4">

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm text-center p-3">
        <div class="fs-3 fw-bold">{{ products|length }}</div>
        <div class="text-muted small">Mga Produkto</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm text-center p-3">
        <div class="fs-3 fw-bold">
          {{ recent_orders|length if recent_orders else 0 }}
        </div>
        <div class="text-muted small">Bagong Order</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm text-center p-3">
        <div class="fs-3 fw-bold">
          {{ current_user.average_rating or 0 }}
        </div>
        <div class="text-muted small">Average na Rating</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm text-center p-3">
        <div class="fs-3 fw-bold">
          ‚Ç±{{ "%.0f"|format(total_revenue or 0) }}
        </div>
        <div class="text-muted small">Kabuuang Kita</div>
      </div>
    </div>

  </div>

  <!-- PRODUCTS -->
  <div class="card border-0 shadow-sm mb-4">

    <div class="card-header bg-transparent fw-bold border-0 pt-3">
      Aking Mga Produkto
    </div>

    <div class="card-body p-0">

      {% if products %}
      <div class="table-responsive">

        <table class="table table-hover mb-0">

          <thead class="table-light">
            <tr>
              <th>Produkto</th>
              <th>Presyo</th>
              <th>Stock</th>
              <th>Status</th>
              <th>Aksyon</th>
            </tr>
          </thead>

          <tbody>
          {% for product in products %}
            <tr>

              <td class="fw-semibold">
                {{ product.name }}
              </td>

              <td class="text-success fw-bold">
                ‚Ç±{{ "%.2f"|format(product.price or 0) }}/{{ product.unit or 'kg' }}
              </td>

              <td>
                {{ product.stock_quantity or 0 }}
              </td>

              <td>
                {% if product.is_available %}
                  <span class="badge bg-success">Aktibo</span>
                {% else %}
                  <span class="badge bg-secondary">Nakatago</span>
                {% endif %}
              </td>

              <td>
                <a href="{{ url_for('products.edit_product',
                                    product_id=product.id) }}"
                   class="btn btn-sm btn-outline-primary">
                   I-edit
                </a>
              </td>

            </tr>
          {% endfor %}
          </tbody>

        </table>

      </div>

      {% else %}

      <div class="text-center py-4 text-muted">
        Wala pang produkto.
      </div>

      {% endif %}
    </div>
  </div>

</div>
{% endblock %}


{% block extra_js %}
{% if current_user.status == "approved" %}
<script>

document.addEventListener("DOMContentLoaded", function() {

  const btn = document.getElementById("startWeighBtn");

  if (btn) {

    btn.addEventListener("click", function() {

      fetch("/api/start-weighing", {
          method: "POST",
          headers: {
              "Content-Type": "application/json"
          },
          body: JSON.stringify({
              farmer_id: {{ current_user.id }}
          })
       })
      .then(res => res.json())
      .then(data => {

          document.getElementById("weighStatus").innerHTML =
          `<div class="alert alert-success mt-3">
              ‚öñ Naka-activate na ang weighing mode.<br>
              Pakilagay ang produkto sa load cell.
           </div>`;

      })
      .catch(error => {

          document.getElementById("weighStatus").innerHTML =
          `<div class="alert alert-danger mt-3">
              Hindi makakonek sa weighing system.
           </div>`;

      });

    });

  }

});

</script>
{% endif %}
{% endblock %}